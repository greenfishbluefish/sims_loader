#!/bin/bash

export COMPOSE_CONVERT_WINDOWS_PATHS=1

DIR=$(git rev-parse --show-toplevel)
cd $DIR

# Validate the docker-compose version >= 1.9.0 on Windows.

if [[ "$@" == "stop" ]]; then
  docker-compose down
elif [[ "$@" == "bash" ]]; then
  docker-compose up -d datastores

  # On Windows, don't convert the paths from Unix format to Windows format.
  # Otherwise, docker volume attachment will fail miserably.
  MSYS_NO_PATHCONV=1 \
  docker run \
    --rm \
    --interactive --tty \
    --network simsloader_default \
    --link simsloader_mysql_1:mysql \
    --volume $(pwd):/app \
    --entrypoint bash \
      simsloader_code
elif [[ "$@" == "build" ]]; then
  for dirname in bin devops lib; do
    find $DIR/$dirname -type f -exec dos2unix -q {} \;
  done

  docker-compose build
else
  # This order is so that we can launch the databases and let them live beyond
  # any given test run.

  # This is idempotent, so do it every time.
  docker-compose up -d datastores

  # TODO: Add waits to ensure that the databases are ready to take traffic.

  # Requires docker-compose >= 1.9.0 on Windows
  if [[ "$@" == "cover" ]]; then
    docker-compose run code cover
  else
    docker-compose run code prove $@
  fi
fi
